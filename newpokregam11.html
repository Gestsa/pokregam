<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoKreGaM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
        }
        nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }
        nav button {
            padding: 8px 15px;
            background-color: #3498db;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        main {
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .hidden {
            display: none;
        }
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .profile-avatar img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
        }
        .profile-stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        .profile-stats div {
            background-color: #ecf0f1;
            padding: 8px 12px;
            border-radius: 5px;
        }
        .post {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .post-avatar img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .game-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tabs button {
            padding: 8px 15px;
            background-color: #ecf0f1;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .tabs button.active {
            background-color: #3498db;
            color: white;
        }
        @media (max-width: 600px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            nav {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>PoKreGaM</h1>
        <nav>
            <button id="navProfile">Profil</button>
            <button id="navGames">Gry</button>
            <button id="navFriends">Znajomi</button>
            <button id="navRanking">Ranking</button>
            <button id="btnLogout">Wyloguj</button>
        </nav>
    </header>

    <main>
        <section id="profileSection">
            <div class="profile-header">
                <div class="profile-avatar">
                    <img id="profileAvatarImg" src="https://placehold.co/100x100/cccccc/000000?text=üë§" alt="Avatar">
                </div>
                <div class="profile-info">
                    <h2 id="profileUsername">Username</h2>
                    <p>Kraj: <span id="profileCountry">Polska</span></p>
                    <div class="profile-stats">
                        <div>Poziom: <span id="profileLevel">1</span></div>
                        <div>XP: <span id="profileXP">0</span></div>
                        <div>Znajomi: <span id="profileFriends">0</span></div>
                    </div>
                </div>
            </div>

            <div class="tabs">
                <button class="active" data-tab="postsTab">Posty</button>
                <button data-tab="gamesTab">Moje gry</button>
                <button data-tab="friendsTab">Znajomi</button>
            </div>

            <div id="postsTab" class="tab-content">
                <h3>Napisz post</h3>
                <textarea id="postContent" rows="3" style="width: 100%; margin-bottom: 10px;"></textarea>
                <button id="publishPostBtn">Opublikuj</button>
                
                <h3 style="margin-top: 20px;">Posty spo≈Çeczno≈õci</h3>
                <div id="communityPosts"></div>
            </div>

            <div id="gamesTab" class="tab-content hidden">
                <h3>Moje gry</h3>
                <button id="createGameBtn">Stw√≥rz nowƒÖ grƒô</button>
                <div id="myGamesList"></div>
            </div>

            <div id="friendsTab" class="tab-content hidden">
                <h3>Znajomi</h3>
                <input type="text" id="friendSearch" placeholder="Wyszukaj znajomych...">
                <button id="searchFriendBtn">Szukaj</button>
                <div id="friendSearchResults" style="margin-top: 15px;"></div>
                
                <h3 style="margin-top: 20px;">Moi znajomi</h3>
                <div id="myFriendsList"></div>
            </div>
        </section>

        <section id="rankingSection" class="hidden">
            <h2>Ranking graczy</h2>
            <table id="rankingTable" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="text-align: left; padding: 8px; background-color: #f2f2f2;">Miejsce</th>
                        <th style="text-align: left; padding: 8px; background-color: #f2f2f2;">Gracz</th>
                        <th style="text-align: left; padding: 8px; background-color: #f2f2f2;">Poziom</th>
                        <th style="text-align: left; padding: 8px; background-color: #f2f2f2;">XP</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </main>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Current user data
        let currentUser = null;
        let currentUserData = {};
        let allUsers = [];

        // DOM Elements
        const profileSection = document.getElementById('profileSection');
        const rankingSection = document.getElementById('rankingSection');
        const profileUsername = document.getElementById('profileUsername');
        const profileCountry = document.getElementById('profileCountry');
        const profileLevel = document.getElementById('profileLevel');
        const profileXP = document.getElementById('profileXP');
        const profileFriends = document.getElementById('profileFriends');
        const profileAvatarImg = document.getElementById('profileAvatarImg');
        const communityPosts = document.getElementById('communityPosts');
        const myGamesList = document.getElementById('myGamesList');
        const myFriendsList = document.getElementById('myFriendsList');
        const friendSearchResults = document.getElementById('friendSearchResults');

        // Initialize the app
        function init() {
            setupEventListeners();
            checkAuthState();
        }

        // Check authentication state
        function checkAuthState() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadUserData();
                    showSection(profileSection);
                } else {
                    // If not logged in, sign in anonymously
                    auth.signInAnonymously()
                        .then(() => {
                            console.log("Signed in anonymously");
                        })
                        .catch(error => {
                            console.error("Anonymous sign-in error:", error);
                        });
                }
            });
        }

        // Load user data from Firestore
        async function loadUserData() {
            if (!currentUser) return;
            
            const userRef = db.collection('users').doc(currentUser.uid);
            const doc = await userRef.get();
            
            if (doc.exists) {
                currentUserData = doc.data();
                updateProfileUI();
                loadCommunityPosts();
                loadUserGames();
                loadFriendsList();
                loadAllUsers();
            } else {
                // Create new user document if it doesn't exist
                currentUserData = {
                    username: `user_${currentUser.uid.substring(0, 8)}`,
                    country: 'Polska',
                    level: 1,
                    xp: 0,
                    friends: [],
                    games: [],
                    avatar: 'https://placehold.co/100x100/cccccc/000000?text=üë§'
                };
                await userRef.set(currentUserData);
                updateProfileUI();
            }
        }

        // Update profile UI with current user data
        function updateProfileUI() {
            profileUsername.textContent = currentUserData.username;
            profileCountry.textContent = currentUserData.country;
            profileLevel.textContent = currentUserData.level;
            profileXP.textContent = currentUserData.xp;
            profileFriends.textContent = currentUserData.friends.length;
            profileAvatarImg.src = currentUserData.avatar;
        }

        // Load community posts
        async function loadCommunityPosts() {
            const postsRef = db.collection('posts').orderBy('timestamp', 'desc');
            const snapshot = await postsRef.get();
            
            communityPosts.innerHTML = '';
            
            snapshot.forEach(doc => {
                const post = doc.data();
                const postElement = document.createElement('div');
                postElement.className = 'post';
                postElement.innerHTML = `
                    <div class="post-header">
                        <div class="post-avatar">
                            <img src="${post.userAvatar || 'https://placehold.co/40x40/cccccc/000000?text=üë§'}" alt="${post.username}">
                        </div>
                        <div>
                            <strong>${post.username}</strong>
                            <small>${new Date(post.timestamp?.toDate()).toLocaleString()}</small>
                        </div>
                    </div>
                    <p>${post.content}</p>
                `;
                communityPosts.appendChild(postElement);
            });
        }

        // Load user's games
        async function loadUserGames() {
            myGamesList.innerHTML = '';
            
            if (currentUserData.games && currentUserData.games.length > 0) {
                currentUserData.games.forEach(game => {
                    const gameElement = document.createElement('div');
                    gameElement.className = 'game-card';
                    gameElement.innerHTML = `
                        <h4>${game.name}</h4>
                        <p>Typ: ${game.type}</p>
                        <p>Status: ${game.published ? 'Opublikowana' : 'W budowie'}</p>
                        <button data-game-id="${game.id}" class="play-game-btn">Graj</button>
                    `;
                    myGamesList.appendChild(gameElement);
                });
            } else {
                myGamesList.innerHTML = '<p>Nie masz jeszcze ≈ºadnych gier. Stw√≥rz nowƒÖ grƒô!</p>';
            }
        }

        // Load friends list
        async function loadFriendsList() {
            myFriendsList.innerHTML = '';
            
            if (currentUserData.friends && currentUserData.friends.length > 0) {
                const friendsSnapshot = await db.collection('users')
                    .where('username', 'in', currentUserData.friends)
                    .get();
                
                friendsSnapshot.forEach(doc => {
                    const friend = doc.data();
                    const friendElement = document.createElement('div');
                    friendElement.className = 'friend-item';
                    friendElement.innerHTML = `
                        <img src="${friend.avatar}" width="40" height="40" style="border-radius:50%;">
                        <span>${friend.username}</span>
                        <button data-uid="${doc.id}" class="remove-friend-btn">Usu≈Ñ</button>
                    `;
                    myFriendsList.appendChild(friendElement);
                });
            } else {
                myFriendsList.innerHTML = '<p>Nie masz jeszcze znajomych.</p>';
            }
        }

        // Load all users for search and ranking
        async function loadAllUsers() {
            const snapshot = await db.collection('users').get();
            allUsers = [];
            
            snapshot.forEach(doc => {
                allUsers.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            updateRanking();
        }

        // Update ranking table
        function updateRanking() {
            const tbody = document.querySelector('#rankingTable tbody');
            tbody.innerHTML = '';
            
            // Sort users by XP (descending)
            const sortedUsers = [...allUsers].sort((a, b) => b.xp - a.xp);
            
            sortedUsers.forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${index + 1}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">
                        <img src="${user.avatar}" width="30" height="30" style="border-radius:50%; vertical-align:middle;">
                        ${user.username}
                    </td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${user.level}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${user.xp}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Show a section and hide others
        function showSection(section) {
            document.querySelectorAll('main section').forEach(sec => {
                sec.classList.add('hidden');
            });
            section.classList.remove('hidden');
        }

        // Switch between tabs
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');
            
            document.querySelectorAll('.tabs button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.tabs button[data-tab="${tabId}"]`).classList.add('active');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            document.getElementById('navProfile').addEventListener('click', () => showSection(profileSection));
            document.getElementById('navGames').addEventListener('click', () => showSection(profileSection));
            document.getElementById('navFriends').addEventListener('click', () => showSection(profileSection));
            document.getElementById('navRanking').addEventListener('click', () => showSection(rankingSection));
            document.getElementById('btnLogout').addEventListener('click', () => auth.signOut());
            
            // Tab buttons
            document.querySelectorAll('.tabs button').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });
            
            // Publish post
            document.getElementById('publishPostBtn').addEventListener('click', async () => {
                const content = document.getElementById('postContent').value.trim();
                if (content) {
                    await db.collection('posts').add({
                        username: currentUserData.username,
                        userAvatar: currentUserData.avatar,
                        content: content,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    document.getElementById('postContent').value = '';
                    loadCommunityPosts();
                }
            });
            
            // Create game
            document.getElementById('createGameBtn').addEventListener('click', async () => {
                const gameName = prompt('Podaj nazwƒô gry:');
                if (gameName) {
                    const gameType = prompt('Podaj typ gry (np. przygodowa, strzelanka):');
                    if (gameType) {
                        const gameId = `game_${Date.now()}`;
                        const newGame = {
                            id: gameId,
                            name: gameName,
                            type: gameType,
                            published: false
                        };
                        
                        // Update user's games array
                        await db.collection('users').doc(currentUser.uid).update({
                            games: firebase.firestore.FieldValue.arrayUnion(newGame)
                        });
                        
                        // Reload games list
                        loadUserGames();
                    }
                }
            });
            
            // Search friends
            document.getElementById('searchFriendBtn').addEventListener('click', searchFriends);
            document.getElementById('friendSearch').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') searchFriends();
            });
        }

        // Search for friends
        async function searchFriends() {
            const searchTerm = document.getElementById('friendSearch').value.toLowerCase();
            friendSearchResults.innerHTML = '';
            
            if (searchTerm.length < 2) return;
            
            const results = allUsers.filter(user => 
                user.username.toLowerCase().includes(searchTerm) && 
                user.id !== currentUser.uid &&
                !currentUserData.friends.includes(user.username)
            );
            
            if (results.length > 0) {
                results.forEach(user => {
                    const resultElement = document.createElement('div');
                    resultElement.className = 'friend-result';
                    resultElement.innerHTML = `
                        <img src="${user.avatar}" width="40" height="40" style="border-radius:50%;">
                        <span>${user.username}</span>
                        <button data-uid="${user.id}" class="add-friend-btn">Dodaj</button>
                    `;
                    friendSearchResults.appendChild(resultElement);
                });
                
                // Add event listeners to add friend buttons
                document.querySelectorAll('.add-friend-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const friendId = btn.dataset.uid;
                        const friendDoc = await db.collection('users').doc(friendId).get();
                        const friendUsername = friendDoc.data().username;
                        
                        // Add to current user's friends list
                        await db.collection('users').doc(currentUser.uid).update({
                            friends: firebase.firestore.FieldValue.arrayUnion(friendUsername)
                        });
                        
                        // Reload friends list
                        loadFriendsList();
                        searchFriends();
                    });
                });
            } else {
                friendSearchResults.innerHTML = '<p>Nie znaleziono u≈ºytkownik√≥w.</p>';
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
